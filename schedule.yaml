# SPDX-License-Identifier: Apache-2.0
# Copyright (c) 2023 Ilia Sotnikov
---
switch:
  # Schedule, lawn sprinklers
  - platform: template
    id: lawn_sprinklers_mon
    name: "Lawn sprinklers: Mon"
    optimistic: true
    restore_state: true
    restore_mode: RESTORE_DEFAULT_OFF
    entity_category: config
  - platform: template
    id: lawn_sprinklers_tue
    name: "Lawn sprinklers: Tue"
    optimistic: true
    restore_state: true
    restore_mode: RESTORE_DEFAULT_OFF
    entity_category: config
  - platform: template
    id: lawn_sprinklers_wed
    name: "Lawn sprinklers: Wed"
    optimistic: true
    restore_state: true
    restore_mode: RESTORE_DEFAULT_OFF
    entity_category: config
  - platform: template
    id: lawn_sprinklers_thu
    name: "Lawn sprinklers: Thu"
    optimistic: true
    restore_state: true
    restore_mode: RESTORE_DEFAULT_OFF
    entity_category: config
  - platform: template
    id: lawn_sprinklers_fri
    name: "Lawn sprinklers: Fri"
    optimistic: true
    restore_state: true
    restore_mode: RESTORE_DEFAULT_OFF
    entity_category: config
  - platform: template
    id: lawn_sprinklers_sat
    name: "Lawn sprinklers: Sat"
    optimistic: true
    restore_state: true
    restore_mode: RESTORE_DEFAULT_OFF
    entity_category: config
  - platform: template
    id: lawn_sprinklers_sun
    name: "Lawn sprinklers: Sun"
    optimistic: true
    restore_state: true
    restore_mode: RESTORE_DEFAULT_OFF
    entity_category: config

  # Schedule, flowerbed sprinklers
  - platform: template
    id: flowerbed_sprinklers_mon
    name: "Flowerbed sprinklers: Mon"
    optimistic: true
    restore_state: true
    restore_mode: RESTORE_DEFAULT_OFF
    entity_category: config
  - platform: template
    id: flowerbed_sprinklers_tue
    name: "Flowerbed sprinklers: Tue"
    optimistic: true
    restore_state: true
    restore_mode: RESTORE_DEFAULT_OFF
    entity_category: config
  - platform: template
    id: flowerbed_sprinklers_wed
    name: "Flowerbed sprinklers: Wed"
    optimistic: true
    restore_state: true
    restore_mode: RESTORE_DEFAULT_OFF
    entity_category: config
  - platform: template
    id: flowerbed_sprinklers_thu
    name: "Flowerbed sprinklers: Thu"
    optimistic: true
    restore_state: true
    restore_mode: RESTORE_DEFAULT_OFF
    entity_category: config
  - platform: template
    id: flowerbed_sprinklers_fri
    name: "Flowerbed sprinklers: Fri"
    optimistic: true
    restore_state: true
    restore_mode: RESTORE_DEFAULT_OFF
    entity_category: config
  - platform: template
    id: flowerbed_sprinklers_sat
    name: "Flowerbed sprinklers: Sat"
    optimistic: true
    restore_state: true
    restore_mode: RESTORE_DEFAULT_OFF
    entity_category: config
  - platform: template
    id: flowerbed_sprinklers_sun
    name: "Flowerbed sprinklers: Sun"
    optimistic: true
    restore_state: true
    restore_mode: RESTORE_DEFAULT_OFF
    entity_category: config

number:
  # Schedule, lawn sprinklers
  - platform: template
    id: lawn_sprinklers_hour
    name: "Lawn sprinklers: Hour"
    entity_category: config
    optimistic: true
    restore_value: true
    initial_value: 0
    min_value: 0
    max_value: 24
    step: 1
    mode: box
  - platform: template
    name: "Lawn sprinklers: Minute"
    id: lawn_sprinklers_minute
    entity_category: config
    optimistic: true
    restore_value: true
    initial_value: 0
    min_value: 0
    max_value: 59
    step: 1
    mode: box

  # Schedule, flowerbed sprinklers
  - platform: template
    name: "Flowerbed sprinklers: Hour"
    id: flowerbed_sprinklers_hour
    entity_category: config
    optimistic: true
    restore_value: true
    initial_value: 0
    min_value: 0
    max_value: 24
    step: 1
    mode: box
  - platform: template
    name: "Flowerbed sprinklers: Minute"
    id: flowerbed_sprinklers_minute
    entity_category: config
    optimistic: true
    restore_value: true
    initial_value: 0
    min_value: 0
    max_value: 59
    step: 1
    mode: box

# Dynamic time.on_time component
esphome:
  includes:
    - ${base_path}/dynamic_on_time.h

custom_component:
  - lambda: |-
      auto lambdacondition_water_tank_empty
        = new LambdaCondition<>([=]() -> bool {
          return !${water_tank_empty_id}->state;
        });

      auto waituntilaction_water_tank_empty
        = new WaitUntilAction<>(lambdacondition_water_tank_empty);
      waituntilaction_water_tank_empty->set_timeout_value(60 * 1000);
      waituntilaction_water_tank_empty->set_component_source("binary_sensor");
      App.register_component(waituntilaction_water_tank_empty);

      const std::vector<esphome::Action<> *> actions_flowerbed = {
        waituntilaction_water_tank_empty,
        new sprinkler::StartFullCycleAction<>(flowerbed_sprinklers)
      };

      const std::vector<esphome::Action<> *> actions_lawn = {
        waituntilaction_water_tank_empty,
        new sprinkler::StartFullCycleAction<>(lawn_sprinklers)
      };

      auto lawn_sprinklers_on_time = new DynamicOnTime(
        "lawn_sprinklers_on_time",
        id(${rtc_id}),
        id(lawn_sprinklers_hour),
        id(lawn_sprinklers_minute),
        id(lawn_sprinklers_mon),
        id(lawn_sprinklers_tue),
        id(lawn_sprinklers_wed),
        id(lawn_sprinklers_thu),
        id(lawn_sprinklers_fri),
        id(lawn_sprinklers_sat),
        id(lawn_sprinklers_sun),
        actions_lawn
      );
      auto flowerbed_sprinklers_on_time = new DynamicOnTime(
        "flowerbed_sprinklers_on_time",
        id(${rtc_id}),
        id(flowerbed_sprinklers_hour),
        id(flowerbed_sprinklers_minute),
        id(flowerbed_sprinklers_mon),
        id(flowerbed_sprinklers_tue),
        id(flowerbed_sprinklers_wed),
        id(flowerbed_sprinklers_thu),
        id(flowerbed_sprinklers_fri),
        id(flowerbed_sprinklers_sat),
        id(flowerbed_sprinklers_sun),
        actions_flowerbed
      );

      return {
        lawn_sprinklers_on_time,
        flowerbed_sprinklers_on_time
      };
    components:
      - id: lawn_sprinklers_on_time
      - id: flowerbed_sprinklers_on_time
